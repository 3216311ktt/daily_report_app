<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>æ—¥å ±ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³è¡¨ç¤º</title>
  <style>
    body {
      max-width: 960px;
      margin: 0 auto;
      font-family: sans-serif;
      padding: 20px;
    }

    .timeline-wrapper {
      overflow-x: auto;
      border: 1px solid #ccc;
      padding: 4px;
      margin-top: 5px;
    }

    .timeline {
      display: inline-flex;
    }

    .slot {
      flex: 0 0 auto;
      width: 26px;
      padding: 4px 2px;
      text-align: left;
      font-size: 10px;
      border-right: 1px solid #eee;
      border-bottom: 1px solid #eee;
      user-select: none;
      padding-left: 2px;
    }

    .slot.selected {
      background-color: #90ee90;
    }

    .slot.excluded {
      background-color: #ddd !important;
      cursor: default;
    }

    .slot.selected.excluded {
      background-color: #ddd !important; /* é¸æŠã‹ã¤é™¤å¤–ã§ã‚‚é™¤å¤–è‰²å„ªå…ˆ */
    }

    .slot.bold-left {
      border-left: 2px solid #555;
    }

    .slot.before-overtime {
      background-color: #ffd8b1 !important;
    }

    .slot.after-overtime {
      background-color: #ffd8b1 !important; 
    }

    .label {
      font-weight: bold;
    }

    .label-overtime {
      font-weight: bold;
      background-color: #ffd8b1 !important;
    }

    form {
      margin-bottom: 20px;
    }

    .daily-group {
      border-top: 2px solid #0077cc;
      margin-top: 40px;
      padding-top: 10px;
    }

    .person-group {
      border-left: 4px solid #ccc;
      padding-left: 10px;
      margin-top: 15px;
      margin-bottom: 15px;
    }

    .person-group h4 {
      margin: 0 0 8px;
      font-size: 16px;
      border-bottom: 1px dashed #aaa;
      padding-bottom: 4px;
    }

    .report-card {
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 12px;
      background: #f9f9f9;
    }

    .daily-person-group {
      border-top: 3px solid #0077cc;
      margin-top: 40px;
      padding-top: 10px;
      background-color: #f9f9f9;
    }

    .daily-person-group h3 {
      font-size: 18px;
      margin-bottom: 12px;
      border-bottom: 1px dashed #aaa;
    }
  </style>
</head>
<body>

<h2>ğŸ“Š æ—¥å ±è¡¨ç¤º</h2>

<form method="get" action="/chart">
  <label>åå‰:
     <select name="name">
      <option value="">--å…¨å“¡--</option>
      {% for n in name_list %}
      <option value="{{ n }}" {% if n == name %}selected{% endif %}>{{ n }}</option>
      {% endfor %}
     </select>
  </label>
     
  <label>æ—¥ä»˜: <input type="date" name="date" value="{{ date or '' }}"></label>
  <button type="submit">æ¤œç´¢</button>
</form>

{% if reports %}
{% set shown_dates = [] %}
{% set ns = namespace(current_key=None) %}

  {% for report in reports %}
    {% set this_key = report.date ~ '_' ~ report.name %}

    {% if this_key != ns.current_key %}
      {% if ns.current_key is not none %}
        </section>
      {% endif %}
      <section class="daily-group">
        <h3>ğŸ“… {{ report.date }}ï½œğŸ‘¤ {{ report.name }}</h3>
        {% set ns.current_key = this_key %}
    {% endif %}

    <div class="report-card">
      <div><span class="label">æ—¥ä»˜:</span> {{ report.date }}ã€€ï½œã€€<span class="label">åå‰:</span> {{ report.name }}</div>
      <div><span class="label">ä»¶å:</span> {{ report.title }}ã€€ï½œã€€<span class="label">ä½œæ¥­å†…å®¹:</span> {{ report.task }}</div>
      {% if report.partner %}
        <div><span class="label">åŒè¡Œè€…:</span> {{ report.partner }}</div>
      {% endif %}
      {% if report.overtime_before %}
        <div><span class="label-overtime">å‰æ®‹æ¥­:</span>
          {{ report.overtime_before // 60 }} æ™‚é–“
          {{ report.overtime_before % 60 }} åˆ†
        </div>
      {% endif %}
      {% if report.overtime_after %}
        <div><span class="label-overtime">å¾Œæ®‹æ¥­:</span>
         {{ report.overtime_after // 60 }} æ™‚é–“
         {{ report.overtime_after % 60 }} åˆ†
        </div>
      {% endif %}
        <div><span class="label">ã“ã®ä½œæ¥­æ™‚é–“:</span>
          {{ (report.total_minutes or 0) // 60 }} æ™‚é–“
          {{ (report.total_minutes or 0) % 60 }} åˆ†
        </div>
      {% if report.date not in shown_dates %}
        <div><span class="label">ãã®æ—¥ã®åˆè¨ˆ:</span>
         {{ (daily_totals[report.date] or 0) // 60 }} æ™‚é–“
         {{ (daily_totals[report.date] or 0) % 60 }} åˆ†
        </div>
        {% set _ = shown_dates.append(report.date) %}
      {% endif %}

      <div style="display: flex; align-items: center;">
        <!-- å·¦ï¼šå‰æ®‹æ¥­è¡¨ç¤º -->
        {% if report.overtime_before %}
          <div style="min-width: 80px; color: #cc5500; font-weight: bold;">
            â± {{ report.overtime_before // 60 }}h {{ report.overtime_before % 60 }}m
          </div>
        {% else %}
          <div style="min-width: 80px;"></div>
        {% endif %}

      <div class="timeline-wrapper" style="flex-grow: 1;">
        <div class="timeline">
          {% for hour in range(8, 18) %}
            {% for minute in [0, 30] %}
              {% set time = hour * 60 + minute %}
              {% set time_str = '{}:{:02d}'.format(hour, minute) %}
              {% set time_in_minutes = time %}

              {% set work_start = report.start_hour * 60 + report.start_minute if report.start_hour is not none else None %}
              {% set work_end = report.end_hour * 60 + report.end_minute if report.end_hour is not none else None %}

              {% set is_before_overtime = report.overtime_before and work_start is not none and time_in_minutes >= work_start - report.overtime_before and time_in_minutes < work_start %}
              {% set is_after_overtime = report.overtime_after and work_end is not none and time_in_minutes > work_end and time_in_minutes <= work_end + report.overtime_after %}


              {# â›”ï¸ é™¤å¤–æ™‚é–“å¸¯ã‹ã©ã†ã‹ãƒã‚§ãƒƒã‚¯ #}
              {% set excluded = time in [480, 720, 750, 1050] %}  {# 8:00, 12:00, 12:30, 17:30 #}

              {% set is_selected = (not excluded and report.start_hour is not none and report.start_minute is not none
                and report.end_hour is not none and report.end_minute is not none
                and (report.start_hour * 60 + report.start_minute) <= time <= (report.end_hour * 60 + report.end_minute)) %}

              {# ç·šã‚’å¤ªãã™ã‚‹æ™‚é–“å¸¯ï¼ˆ8:30 / 17:30ï¼‰#}
              {% set bold_left = time in [510, 1050] %}
                
              <div class="slot
                          {% if is_selected %}selected{% endif %}
                          {% if excluded %}excluded{% endif %}
                          {% if bold_left %}bold-left{% endif %}
                          {% if is_before_overtime %}before-overtime{% endif %}
                          {% if is_after_overtime %}after-overtime{% endif %}
                          ">
                {{ hour if minute == 0 else '' }}
              </div>
            {% endfor %}
          {% endfor %}
        </div>
      </div>

        <!-- å³ï¼šå¾Œæ®‹æ¥­è¡¨ç¤º -->
        {% if report.overtime_after %}
          <div style="min-width: 80px; color: #cc5500; font-weight: bold;">
            â± {{ report.overtime_after // 60 }}h {{ report.overtime_after % 60 }}m
          </div>
        {% else %}
          <div style="min-width: 80px;"></div>
        {% endif %}
    </div>
    </div>
    
  {% endfor %}
  <!-- ãƒ«ãƒ¼ãƒ—çµ‚äº† -->
  {% if current_key is not none %}
    </section>
  {% endif %}
  {% if name and reports %}
  <!-- ãƒ«ãƒ¼ãƒ—è¡¨ç¤º... -->

    <hr>
    <div style="font-weight: bold; font-size: 16px; margin-top: 20px;">
      ğŸ“† æœˆã®ä½œæ¥­æ™‚é–“ç´¯è¨ˆ ({{ name }}ã•ã‚“):
                          {{ monthly_total // 60 }} æ™‚é–“
                          {{ monthly_total % 60 }} åˆ†
    </div>
  {% endif %}

{% else %}
  <p>è©²å½“ã™ã‚‹ãƒ¬ãƒãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚</p>
{% endif %}

<a href="/">â†ã€€å…¥åŠ›ç”»é¢</a>
</body>
</html>

