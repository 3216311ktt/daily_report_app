<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>æ—¥å ±ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³è¡¨ç¤º</title>
  <style>
    body {
      max-width: 960px;
      margin: 0 auto;
      font-family: sans-serif;
      padding: 20px;
    }

    .timeline-wrapper {
      overflow-x: auto;
      border: 1px solid #ccc;
      padding: 4px;
      margin-top: 5px;
    }

    .timeline {
      display: inline-flex;
    }

    .slot {
      flex: 0 0 auto;
      width: 26px;
      padding: 4px 2px;
      text-align: left;
      font-size: 10px;
      border-right: 1px solid #eee;
      border-bottom: 1px solid #eee;
      user-select: none;
      padding-left: 2px;
    }

    .slot.selected {
      background-color: #90ee90;
    }

    .slot.excluded {
      background-color: #ddd !important;
      cursor: default;
    }

    .slot.selected.excluded {
      background-color: #ddd !important; /* é¸æŠã‹ã¤é™¤å¤–ã§ã‚‚é™¤å¤–è‰²å„ªå…ˆ */
    }

    .slot.disabled {
      background-color: #f0f0f0;
    }

    .slot.bold-left {
      border-left: 2px solid #555;
    }

    .report-card {
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 16px;
      background: #f9f9f9;
    }

    .label {
      font-weight: bold;
    }

    form {
      margin-bottom: 20px;
    }
  </style>
</head>
<body>

<h2>ğŸ“Š æ—¥å ±è¡¨ç¤º</h2>

<form method="get" action="/chart">
  <label>åå‰:
     <select name="name">
      <option value="">--å…¨å“¡--</option>
      {% for n in name_list %}
      <option value="{{ n }}" {% if n == name %}selected{% endif %}>{{ n }}</option>
      {% endfor %}
     </select>
  </label>
     
  <label>æ—¥ä»˜: <input type="date" name="date" value="{{ date or '' }}"></label>
  <button type="submit">æ¤œç´¢</button>
</form>

{% if reports %}
{% set shown_dates = [] %}
  {% for report in reports %}
    <div class="report-card">
      <div><span class="label">æ—¥ä»˜:</span> {{ report.date }}ã€€ï½œã€€<span class="label">åå‰:</span> {{ report.name }}</div>
      <div><span class="label">ä»¶å:</span> {{ report.title }}ã€€ï½œã€€<span class="label">ä½œæ¥­å†…å®¹:</span> {{ report.task }}</div>
      {% if report.partner %}
        <div><span class="label">åŒè¡Œè€…:</span> {{ report.partner }}</div>
      {% endif %}
      {% if report.overtime_before %}
        <div><span class="label">å‰æ®‹æ¥­:</span>
          {{ report.overtime_before // 60 }} æ™‚é–“
          {{ report.overtime_before % 60 }} åˆ†
        </div>
      {% endif %}
      {% if report.overtime_after %}
        <div><span class="label">å¾Œæ®‹æ¥­:</span>
         {{ report.overtime_after // 60 }} æ™‚é–“
         {{ report.overtime_after % 60 }} åˆ†
        </div>
      {% endif %}
        <div><span class="label">ã“ã®ä½œæ¥­æ™‚é–“:</span>
          {{ (report.total_minutes or 0) // 60 }} æ™‚é–“
          {{ (report.total_minutes or 0) % 60 }} åˆ†
        </div>
      {% if report.date not in shown_dates %}
        <div><span class="label">ãã®æ—¥ã®åˆè¨ˆ:</span>
         {{ (daily_totals[report.date] or 0) // 60 }} æ™‚é–“
         {{ (daily_totals[report.date] or 0) % 60 }} åˆ†
        </div>
        {% set _ = shown_dates.append(report.date) %}
      {% endif %}


      <div class="timeline-wrapper">
        <div class="timeline">
          {% for hour in range(8, 18) %}
            {% for minute in [0, 30] %}
              {% set time = hour * 60 + minute %}
              {% set time_str = '{}:{:02d}'.format(hour, minute) %}

              {# â›”ï¸ é™¤å¤–æ™‚é–“å¸¯ã‹ã©ã†ã‹ãƒã‚§ãƒƒã‚¯ #}
              {% set excluded = time in [480, 720, 750, 1050] %}  {# 8:00, 12:00, 12:30, 17:30 #}

              {% set is_selected = (not excluded and report.start_hour is not none and report.start_minute is not none
                and report.end_hour is not none and report.end_minute is not none
                and (report.start_hour * 60 + report.start_minute) <= time <= (report.end_hour * 60 + report.end_minute)) %}

              {# ç·šã‚’å¤ªãã™ã‚‹æ™‚é–“å¸¯ï¼ˆ8:30 / 17:30ï¼‰#}
              {% set bold_left = time in [510, 1050] %}
                
              <div class="slot
                          {% if is_selected %}selected{% endif %}
                          {% if excluded %}excluded{% endif %}
                          {% if bold_left %}bold-left{% endif %}">
                {{ hour if minute == 0 else '' }}
              </div>
            {% endfor %}
          {% endfor %}
        </div>
      </div>
    </div>
  {% endfor %}
  {% if name and reports %}
  <!-- ãƒ«ãƒ¼ãƒ—è¡¨ç¤º... -->

    <hr>
    <div style="font-weight: bold; font-size: 16px; margin-top: 20px;">
      ğŸ“† æœˆã®ä½œæ¥­æ™‚é–“ç´¯è¨ˆ ({{ name }}ã•ã‚“):
                          {{ monthly_total // 60 }} æ™‚é–“
                          {{ monthly_total % 60 }} åˆ†
    </div>
  {% endif %}

{% else %}
  <p>è©²å½“ã™ã‚‹ãƒ¬ãƒãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚</p>
{% endif %}

<a href="/">â†ã€€å…¥åŠ›ç”»é¢</a>
</body>
</html>

