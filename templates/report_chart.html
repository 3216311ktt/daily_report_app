<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <link rel="stylesheet" href="static/report_chart_style.css">
  <title>日報タイムライン表示</title>
  
</head>
<body>

<h2>📊 日報表示</h2>

<form method="get" action="/chart">
  <label>名前:
     <select name="name">
      <option value="">--全員--</option>
      {% for n in name_list %}
      <option value="{{ n }}" {% if n == name %}selected{% endif %}>{{ n }}</option>
      {% endfor %}
     </select>
  </label>
     
  <label>日付: <input type="date" name="date" value="{{ date or '' }}"></label>
  <button type="submit">検索</button>
</form>

{% if reports %}
{% set shown_dates = [] %}
{% set ns = namespace(current_key=None) %}

  {% for report in reports %}
    {% set this_key = report.date ~ '_' ~ report.name %}

    {% if this_key != ns.current_key %}
      {% if ns.current_key is not none %}
        </section>
      {% endif %}
      <section class="daily-group">
        <h3>📅 {{ report.date }}｜👤 {{ report.name }}</h3>
        {% set ns.current_key = this_key %}
    {% endif %}

    <div class="report-card">
      <div><span class="label">日付:</span> {{ report.date }}　｜　<span class="label">名前:</span> {{ report.name }}</div>
      <div><span class="label">件名:</span> {{ report.title }}　｜　<span class="label">作業内容:</span> {{ report.task }}</div>
      {% if report.partner %}
        <div><span class="label">同行者:</span> {{ report.partner }}</div>
      {% endif %}
      {% set this_key = report.date ~ '_' ~ report.name %}
      {% if holiday_info[this_key] %}
        <div style="color: red; font-weight: bold;">※休日出勤</div>
      {% endif %}
      {% if report.overtime_before %}
        <div><span class="label-overtime">前残業:</span>
          {{ report.overtime_before // 60 }} 時間
          {{ report.overtime_before % 60 }} 分
        </div>
      {% endif %}
      {% if report.overtime_after %}
        <div><span class="label-overtime">後残業:</span>
         {{ report.overtime_after // 60 }} 時間
         {{ report.overtime_after % 60 }} 分
        </div>
      {% endif %}
        <div><span class="label">この作業時間:</span>
          {{ (report.total_minutes or 0) // 60 }} 時間
          {{ (report.total_minutes or 0) % 60 }} 分
        </div>
      {% set date_name_key = report.date ~ '_' ~ report.name %}
      {% if date_name_key not in shown_dates %}
        <div><span class="label">その日の合計:</span>
         {{ (daily_totals[report.date ~ '_' ~ report.name] or 0) // 60 }} 時間
         {{ (daily_totals[report.date ~ '_' ~ report.name] or 0) % 60 }} 分
        </div>
        {% set _ = shown_dates.append(date_name_key) %}
      {% endif %}

      <div style="display: flex; align-items: center;">
        <!-- 左：前残業表示 -->
        {% if report.overtime_before %}
          <div style="min-width: 80px; color: #cc5500; font-weight: bold;">
            ⏱ {{ report.overtime_before // 60 }}h {{ report.overtime_before % 60 }}m
          </div>
        {% else %}
          <div style="min-width: 80px;"></div>
        {% endif %}

      <div class="timeline-wrapper" style="flex-grow: 1;">
        <div class="timeline">
          {% for hour in range(8, 18) %}
            {% for minute in [0, 30] %}
              {% set time = hour * 60 + minute %}
              {% set time_str = '{}:{:02d}'.format(hour, minute) %}
              {% set time_in_minutes = time %}

              {% set work_start = report.start_hour * 60 + report.start_minute if report.start_hour is not none else None %}
              {% set work_end = report.end_hour * 60 + report.end_minute if report.end_hour is not none else None %}

              {% set is_before_overtime = report.overtime_before and work_start is not none and time_in_minutes >= work_start - report.overtime_before and time_in_minutes < work_start %}
              {% set is_after_overtime = report.overtime_after and work_end is not none and time_in_minutes > work_end and time_in_minutes <= work_end + report.overtime_after %}


              {# ⛔️ 除外時間帯かどうかチェック #}
              {% set excluded = time in [480, 720, 750, 1050] %}  {# 8:00, 12:00, 12:30, 17:30 #}

              {% set is_selected = (not excluded and report.start_hour is not none and report.start_minute is not none
                and report.end_hour is not none and report.end_minute is not none
                and (report.start_hour * 60 + report.start_minute) <= time <= (report.end_hour * 60 + report.end_minute)) %}

              {# 線を太くする時間帯（8:30 / 17:30）#}
              {% set bold_left = time in [510, 1050] %}
                
              <div class="slot
                          {% if is_selected %}selected{% endif %}
                          {% if excluded %}excluded{% endif %}
                          {% if bold_left %}bold-left{% endif %}
                          {% if is_before_overtime %}before-overtime{% endif %}
                          {% if is_after_overtime %}after-overtime{% endif %}
                          ">
                {{ hour if minute == 0 else '' }}
              </div>
            {% endfor %}
          {% endfor %}
        </div>
      </div>

        <!-- 右：後残業表示 -->
        {% if report.overtime_after %}
          <div style="min-width: 80px; color: #cc5500; font-weight: bold;">
            ⏱ {{ report.overtime_after // 60 }}h {{ report.overtime_after % 60 }}m
          </div>
        {% else %}
          <div style="min-width: 80px;"></div>
        {% endif %}
    </div>
    </div>
    
  {% endfor %}
  <!-- ループ終了 -->
  {% if current_key is not none %}
    </section>
  {% endif %}
  {% if name and reports %}
  <!-- ループ表示... -->

    <hr>
    <div style="font-weight: bold; font-size: 16px; margin-top: 20px;">
      📆 月の作業時間累計 ({{ name }}さん):
                          {{ monthly_total // 60 }} 時間
                          {{ monthly_total % 60 }} 分
    </div>
  {% endif %}

{% else %}
  <p>該当するレポートが見つかりません。</p>
{% endif %}

<a href="/">←　入力画面</a>
</body>
</html>

