<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" >
  <link rel="stylesheet" href="static/index_style.css">
  <title>æ—¥å ±å…¥åŠ›</title>

</head>
<body>


<h2>ğŸ“ æ—¥å ±å…¥åŠ›</h2>
  <label style="color: rgb(251, 38, 0);">
    <input type="checkbox" id="isHolidayWork" {% if is_holiday %}checked{% endif %}>
     ä¼‘æ—¥å‡ºå‹¤
  </label>
  <br>
<tr>
  <label>åå‰</label>
  <select id="nameSelect" onchange="toggleNameInpit()">
    <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
    {% for n in name_list %}
    <option value="{{ n }}">{{ n }}</option>
    {% endfor %}
    <option value="__other__">ãã®ä»–ï¼ˆæ–°è¦å…¥åŠ›ï¼‰</option>
  </select>
  <input type="text" id="customName" placeholder="åå‰å…¥åŠ›" style="display: none;">
  <label for="dateInput"> æ—¥ä»˜ã‚’é¸æŠ</label>
  <input type="date" id="dateInput" name="date" onchange="checkIfHoliday()">
  <label for="entryCountSelector">ä»¶åæ•°</label>
  <select id="entryCountSelector">
    <option value="1" selected>1ã€€ä»¶</option>
    <option value="2">2ã€€ä»¶</option>
    <option value="3">3ã€€ä»¶</option>
    <option value="4">4ã€€ä»¶</option>
    <option value="5">5ã€€ä»¶</option>
  </select>
</tr>
<br>
<br>
<div id="entries"></div>


<style>

/* PCãƒ»ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆï¼ˆ768PXä»¥ä¸Šï¼‰ */
@media screen and (min-width: 768px) {
  .timeline-row {
    display: flex;
    flex-direction: row;
    align-items: center;
    gap: 8px;
  }

  .bottom-row {
    display: flex;
    align-items: center;
    justify-content: flex-end;
    margin-top: 6px;
    width: 780px;
  }
}

/* ã‚¹ãƒãƒ›ã®ã¿ï¼ˆ767pxä»¥ä¸‹ï¼‰ */
@media screen and (max-width: 767px) {
  .timeline-row {
    display: flex;
    flex-direction: column;
    align-items: stretch;
    gap: 8px;
  }

  .before-wrapper,
  .timeline-wrapper,
  .after-wrapper {
    width: 100%;
  }

  /* åˆå‰ãƒ»åˆå¾Œã‚¹ãƒ­ãƒƒãƒˆã‚’åˆ†å‰²ã™ã‚‹ãŸã‚ã«ãƒœãƒ¼ãƒ€ãƒ¼ or ä½™ç™½ */
  .timeline-wrapper .morning-slots {
    border-bottom: 1px solid #ccc;
    margin-bottom: 6px;
    padding-bottom: 6px;
  }

  .bottom-row {
    display: flex;
    align-items: center;
    justify-content: flex-start;
    margin-top: 8px;
    width: 100%;
  }

  .clear-button {
    width: auto;
    margin-left: 0;
  }
}

/* ãƒ¢ãƒ¼ãƒ€ãƒ«ç”¨ã®CSSã‚’è¿½åŠ  */
/* ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
#modalOverlay {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.4);
  z-index: 9998;
  opacity: 0;
  transition: opacity 0.3s ease;
}
#modalOverlay.active {
  display: block;
  opacity: 1;
}


  /* å…±é€šãƒ¢ãƒ¼ãƒ€ãƒ«èƒŒæ™¯ */
#timeModal {
  display: none;
  background: #fff;
  border-radius: 10px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.3);
  padding: 1rem;
  z-index: 9999;
  opacity: 0;
  transition: opacity 0.3s ease, transform 0.3s ease;
  position: absolute;
  max-height: 300px;
  overflow-y: auto;
}

/* PCç”¨ãƒ¢ãƒ¼ãƒ€ãƒ« */
@media (min-width: 769px) {
  #timeModal {
    position: absolute;
    max-height: 300px;
    overflow-y: auto;
    transform: none;
  }
}

/* ã‚¹ãƒãƒ›ç”¨ãƒ¢ãƒ¼ãƒ€ãƒ« */
@media (max-width: 767px) {
  #timeModal {
    position: fixed;   
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 30%;
    max-height: 60vh;
    background: #fff;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.3);
    padding: 1rem;
    opacity: 0;
    transition: opacity 0.3s ease, transform 0.3s ease;
  }

  #timeModal.active {
    opacity: 1;
  }
}

/* activeçŠ¶æ…‹ï¼ˆãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³ï¼‰ */
#timeModal.active {
  opacity: 1;
}

.time-option {
  padding: 0.75rem;
  font-size: 1.2rem;
  text-align: center;
  border-bottom: 1px solid #eee;
}
.time-option:hover {
  background: #f0f0f0;
}
.clear-btn {
  margin-bottom: 0.5rem;
  font-size: 1rem;
  background: #eee;
  border: none;
  padding: 0.5rem;
  cursor: pointer;
}

</style>

<!-- ãƒ¢ãƒ¼ãƒ€ãƒ«HTML -->
<div id="modalOverlay"></div>

<div id="timeModal" class="time-modal">
    <div class="time-modal-content" id="timeOptionsContainer">
      <button id="clearTimeModal" class="clear-btn">ã‚¯ãƒªã‚¢</button>
    </div>
</div>


<div class="total-time">ç·åˆè¨ˆæ™‚é–“: <span id="overall-total">0</span> æ™‚é–“</div>
<div class="total-time">æ®‹æ¥­æ™‚é–“åˆè¨ˆ: <span id="overtime-total">0</span> æ™‚é–“</div>

<button onclick="submitReports()" class="submit">é€ä¿¡</button>
<a href="/chart">â†ã€€è¡¨ç¤ºç”»é¢</a>
<br>
<a href="/view_reports">â†ã€€ç·¨é›†ç”»é¢</a>

<script>

  const startHour = 8;
  const endHour = 18;
  const interval = 30;

  const entriesEl = document.getElementById('entries');
  const overallTotalEl = document.getElementById('overall-total');
  const overtimeTotalEl = document.getElementById('overtime-total');
  const entryCountSelector = document.getElementById('entryCountSelector');
  
  let allEntries = [];

  // å¤‰æ›ç”¨
  function timeToMinutes(str) {
    if (!str) return 0;
    const [h, m] = str.split(':').map(Number);
    return h * 60 + m;
  }

  // æ™‚é–“æ–‡å­—åˆ—ã‚’åˆ†ã«å¤‰æ›
  function timeStrToMinutes(str, type) {
    if (!str) return 0;
    const [h, m] = str.split(':').map(Number);
    let totalMinutes = h * 60 + m;

    // æ·±å¤œã‚’ç¿Œæ—¥ã®æ™‚é–“ã¨ã—ã¦è£œæ­£
    if (type === 'after' && totalMinutes < 300) {
      totalMinutes += 1440;
    }

    if (type === 'before') {
      return totalMinutes < 480 ? 480 - totalMinutes : 0;
    } else if (type === 'after') {
      return totalMinutes > 1080 ? totalMinutes - 1080 : 0;
    }
    return 0;
  }

  // ä¼‘æ—¥å‡ºå‹¤æ™‚ã¯æœ‰çµ¦å…¥åŠ›æ¬„ã‚’éè¡¨ç¤º
  function togglePaidLeaveVisibility(isHoliday) {
    const paidLeaveInputs = document.querySelectorAll('.paid_leave');

    paidLeaveInputs.forEach(input => {
      if (isHoliday) {
        input.style.display = 'none'; // ä¼‘æ—¥å‡ºå‹¤æ™‚ã¯éè¡¨ç¤º
        input.value = ''; // å€¤ã‚‚ã‚¯ãƒªã‚¢
      } else {
        input.style.display ='inline-block'; // é€šå¸¸æ™‚ã¯è¡¨ç¤º
      }
    });
  }

  // å…¨ã‚¨ãƒ³ãƒˆãƒªã®ä¸­ã§ã€æœ€ã‚‚é…ã„ã€€overtimeEnd ã‚’è¿”ã™
  function getLatestActualEnd(entries) {
    let latestMinutes = -1;
    let latestTime = null;

    entries.forEach(entry => {
      const endTimeStr = entry.overtimeEnd || entry.end;
      if (entry.overtimeEnd && typeof entry.overtimeEnd === 'string') {
        const minutes = timeToMinutes(endTimeStr);
        if (minutes > latestMinutes) {
          latestMinutes = minutes;
          latestTime = endTimeStr;
        }
      }
    });

    return latestTime;
  }

  // é€šå¸¸æ™‚é–“ã®é‡ãªã‚Šé˜²æ­¢å¯¾ç­–
  function updateSlotDisabling() {
  // å…¨ã‚¨ãƒ³ãƒˆãƒªã®ä¸­ã§ã€å„ã‚¹ãƒ­ãƒƒãƒˆãŒã©ã®ã‚¨ãƒ³ãƒˆãƒªã«é¸ã°ã‚Œã¦ã„ã‚‹ã‹ã‚’æŠŠæ¡
  const usedSlots = new Set();

  allEntries.forEach(entry => {
    entry.slots.forEach(slot => {
      if (slot.classList.contains('selected')) {
        usedSlots.add(slot.dataset.time);
      }
    });
  });

  // å„ã‚¨ãƒ³ãƒˆãƒªã”ã¨ã«ã‚¹ãƒ­ãƒƒãƒˆã‚’æ›´æ–°
  allEntries.forEach(entry => {
    entry.slots.forEach(slot => {
      const slotTime = slot.dataset.time;
      const baseDisabled = slot.dataset.baseDisabled === 'true';
      const isSelected = slot.classList.contains('selected');

      if (baseDisabled) {
        // ãƒ™ãƒ¼ã‚¹ã§ç„¡åŠ¹ï¼ˆæ˜¼ä¼‘ã¿ãªã©ï¼‰
        slot.classList.add('disabled');
      } else if (isSelected) {
        // è‡ªåˆ†ãŒé¸æŠä¸­ãªã‚‰å¸¸ã«æœ‰åŠ¹
        slot.classList.remove('disabled');
      } else if (usedSlots.has(slotTime)) {
        // ä»–ã‚¨ãƒ³ãƒˆãƒªã§ä½¿ã‚ã‚Œã¦ã„ã‚‹ã‚¹ãƒ­ãƒƒãƒˆ â†’ ç„¡åŠ¹
        slot.classList.add('disabled');
        slot.classList.remove('selected'); // å¿µã®ãŸã‚
      } else {
        // ä½¿ã‚ã‚Œã¦ã„ãªã„ï¼†è‡ªåˆ†ã‚‚æœªé¸æŠ â†’ æœ‰åŠ¹
        slot.classList.remove('disabled');
      }
    });
  });
}



  // ä¼‘æ—¥åˆ¤å®šã®ãŸã‚ã®é–¢æ•°
  function checkIfHoliday() {
  const date = document.getElementById('dateInput').value;
  if (!date) return;

  fetch(`/api/check_holiday?date=${date}`)
    .then(response => response.json())
    .then(data => {
      const isHoliday = data.is_holiday;
      const holidayCheckbox = document.getElementById('isHolidayWork');

      // ä¼‘æ—¥å‡ºå‹¤ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®çŠ¶æ…‹ã‚’æ›´æ–°
      holidayCheckbox.checked = isHoliday;
      console.log(`ã“ã®æ—¥ã¯ä¼‘æ—¥ï¼Ÿ: ${isHoliday}`);

      togglePaidLeaveVisibility(isHoliday);
    })
    .catch(err => console.error(err));
}
  // åˆæœŸåŒ–
  document.addEventListener('DOMContentLoaded', () => {
    checkIfHoliday();

     // ä¼‘æ—¥å‹¤å‹™ãƒã‚§ãƒƒã‚¯ãŒæ‰‹å‹•ã§åˆ‡ã‚Šæ›¿ã‚ã£ãŸæ™‚ã«ã‚‚æœ‰ä¼‘æ¬„ã‚’æ›´æ–°
    document.getElementById('isHolidayWork').addEventListener('change', function () {
    togglePaidLeaveVisibility(this.checked);
  });
});

  // ä»¶åæ•°ã‚»ãƒ¬ã‚¯ã‚¿ã®å¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆ
  function createTimeSlots() {
    const slots = [];
    for (let h = startHour; h < endHour; h++) {
      for (let m of [0, 30]) {
        const time = `${h}:${m.toString().padStart(2, '0')}`;
        const label = m === 0 ? `${h}` : ``;

        const isDisabled = (h === 8 && m === 0) || (h === 12 && m <= 30) || (h === 17 && m == 30);
        const isBoldLeft = (h === 8 && m === 30) || (h === 17 && m === 30);

        slots.push({ time, label, disabled: isDisabled, boldLeft: isBoldLeft, baseDisabled: isDisabled });
      }
    }
    return slots;
  }

  function createEntries(entryCount) {
    entriesEl.innerHTML = '';
    allEntries = []

  for (let i = 0; i < entryCount; i++) {
    const wrapper = document.createElement('div');
    wrapper.className = 'entry';

    const fieldRow = document.createElement('div');
    fieldRow.className = 'entry-fields';

    const titleInput = document.createElement('input');
    titleInput.type = 'text';
    titleInput.placeholder = `ä»¶å ${i + 1}`;
    titleInput.className = 'title';

    const taskInput = document.createElement('input');
    taskInput.type = 'text';
    taskInput.placeholder = `ä½œæ¥­å†…å®¹`;
    taskInput.className = 'task';

    const partnerInput = document.createElement('input');
    partnerInput.type = 'text';
    partnerInput.placeholder = `åŒè¡Œè€…`;
    partnerInput.className = 'partner';

    // æœ‰çµ¦å…¥åŠ›æ¬„ã‚’ä½œæˆ
    const paidLeaveInput = document.createElement('input');
    paidLeaveInput.type = 'number';
    paidLeaveInput.step= '0.5';
    paidLeaveInput.placeholder = 'æœ‰çµ¦(æ™‚é–“)';
    paidLeaveInput.className = 'paid_leave';
    paidLeaveInput.min = 0;
    paidLeaveInput.style.marginTop = '4px';
    paidLeaveInput.style.width ='120px'

    // åˆæœŸå€¤ï¼˜æ™‚é–“
    paidLeaveInput.addEventListener('focus', function(){
      if (this.value === '') {
        this.value = 8;
      }
    })
    
    fieldRow.appendChild(titleInput);
    fieldRow.appendChild(taskInput);
    fieldRow.appendChild(partnerInput);
    fieldRow.appendChild(paidLeaveInput);
    wrapper.appendChild(fieldRow);

    const timelineRow = document.createElement('div');
    timelineRow.className = 'timeline-row';

    // === å‰æ®‹æ¥­ ===
    const beforeWrapper = document.createElement('div');
    beforeWrapper.style.marginRight = '10px';
    const beforeLabel = document.createElement('label');
    beforeLabel.textContent = 'å‰æ®‹æ¥­: ';
    const overtimeBefore = document.createElement('input');
    overtimeBefore.type = 'text';
    overtimeBefore.className = 'overtime-timepicker';
    overtimeBefore.placeholder = 'å‰æ®‹æ¥­æ™‚åˆ»';
    overtimeBefore.readOnly = true;  // æ‰‹å…¥åŠ›é˜²æ­¢
    overtimeBefore.style.width = '65px';
    overtimeBefore.addEventListener('click', () => showTimeModal(overtimeBefore, 'before'));

    beforeWrapper.appendChild(beforeLabel);
    beforeWrapper.appendChild(overtimeBefore);

    // === å¾Œæ®‹æ¥­ ===
    const afterWrapper = document.createElement('div');
    afterWrapper.style.marginLeft = '10px';
    const afterLabel = document.createElement('label');
    afterLabel.textContent = 'å¾Œæ®‹æ¥­: ';
    const overtimeAfter = document.createElement('input');
    overtimeAfter.type = 'text';
    overtimeAfter.className = 'overtime-timepicker';
    overtimeAfter.placeholder = 'å¾Œæ®‹æ¥­æ™‚åˆ»';
    overtimeAfter.readOnly = true;
    overtimeAfter.style.width = '65px';
    overtimeAfter.addEventListener('click', () => showTimeModal(overtimeAfter, 'after', allEntries));
    
    afterWrapper.appendChild(afterLabel);
    afterWrapper.appendChild(overtimeAfter);


    // === ğŸ§¹ ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³ã®è¿½åŠ  ===
    const clearBtn = document.createElement('button');
    clearBtn.className = 'clear-button';
    clearBtn.textContent = 'ã‚¯ãƒªã‚¢';
    clearBtn.style.fontSize = '12px';
    clearBtn.style.padding = '4px 10px';
    clearBtn.style.flexShrink = '0';

    clearBtn.addEventListener('click', () => {
      // ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³ã®è¦ªã®ç‰¹å®š
      const entryEl = clearBtn.closest('.entry');

      // ã‚¹ãƒ­ãƒƒãƒˆé¸æŠè§£é™¤
      entryEl.querySelectorAll('.slot.selected').forEach(s => s.classList.remove('selected'));

      updateAllTotals();
     
  });

    // ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³
    const timelineWrapper = document.createElement('div');
    timelineWrapper.className = 'timeline-wrapper';

    const timeline = document.createElement('div');
    timeline.className = 'timeline';

    const slots = createTimeSlots().map(({ time, label, disabled, boldLeft, baseDisabled }) => {
      const el = document.createElement('div');
      el.className = 'slot';
      if (baseDisabled) el.classList.add('disabled');
      if (boldLeft) el.classList.add('bold-left');
      el.dataset.time = time;
      el.textContent = label;
      el.dataset.baseDisabled = baseDisabled ? 'true' : 'false';

      timeline.appendChild(el);
      return el;
    });

    timelineWrapper.appendChild(timeline);

    timelineRow.appendChild(beforeWrapper);
    timelineRow.appendChild(timelineWrapper);
    timelineRow.appendChild(afterWrapper);
    
    wrapper.appendChild(timelineRow);

    // å‡ºåŠ›è¡Œã¨ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³ã‚’åŒ…ã‚€ã€€div ã‚’ä½œæˆ
    const bottomRow = document.createElement('div');
    bottomRow.className = 'bottom-row'
    bottomRow.style.alignItems = 'center';
    bottomRow.style.marginTop = '6px';
    bottomRow.style.boxSizing = 'border-box';

    // é¸æŠæ™‚é–“ã‚’è¡¨ç¤º
    const output = document.createElement('div');
    output.className = 'output';
    output.textContent = `é¸æŠæ™‚é–“: 0 æ™‚é–“`;

    // spacer
    const spacer = document.createElement('div');
    spacer.style.flex = '1';

    bottomRow.appendChild(output);
    bottomRow.appendChild(spacer);
    bottomRow.appendChild(clearBtn);
    wrapper.appendChild(bottomRow);

    entriesEl.appendChild(wrapper);

    allEntries.push({ slots, output, overtimeBefore, overtimeAfter, paidLeaveInput, overtimeEnd: null });
  }

  setupSlotEventHandlers();
  updateAllTotals();
}

  function setupSlotEventHandlers() {
    allEntries.forEach(entry => {
      let isDragging = false;

      entry.slots.forEach(slot => {
        function toggleSlot(target) {
          if (target.classList.contains('disabled')) return;
          target.classList.toggle('selected');
          updateAllTotals();
        }

        function selectSlot(target) {
          if (target.classList.contains('disabled') || target.classList.contains('selected')) return;
          target.classList.add('selected');
          updateAllTotals();
        }

        slot.addEventListener('mousedown', () => {
          isDragging = true;
          toggleSlot(slot);
        });

        slot.addEventListener('mousemove', (e) => {
          if (isDragging && e.buttons) {
            selectSlot(slot);
          }
        });

        slot.addEventListener('touchstart', (e) => {
          e.preventDefault();
          isDragging = true;
          toggleSlot(slot);
        }, { passive: false });

        slot.addEventListener('touchmove', (e) => {
          e.preventDefault();
          const touch = e.touches[0];
          const target = document.elementFromPoint(touch.clientX, touch.clientY);
          if (target && target.classList.contains('slot')) {
            selectSlot(target);
          }
        }, { passive: false });

        document.addEventListener('mouseup', () => isDragging = false);
        document.addEventListener('touchend', () => isDragging = false);
      });

      entry.overtimeBefore.addEventListener('change', updateAllTotals);
      entry.overtimeAfter.addEventListener('change', updateAllTotals);
    });
  }

  function updateAllTotals() {
    let totalMinutes = 0;
    let totalOvertime = 0;

    // é€šå¸¸æ™‚é–“ã€€ï¼‹ã€€å‰æ®‹æ¥­ã‚’å…ˆã«è¨ˆç®—
    const entryData = allEntries.map(entry => {
      const selected = entry.slots.filter(s => s.classList.contains('selected'));
      const workMinutes = selected.length * 30;
      const overtimeBeforeMinutes = timeStrToMinutes(entry.overtimeBefore.value, 'before');

      return {
        entry,
        workMinutes,
        overtimeBeforeMinutes,
        overtimeAfterMinutes: 0,
        overtimeEndMinutes: entry.overtimeEnd ? timeToMinutes(entry.overtimeEnd) : null
      };
    });

    // å¾Œæ®‹æ¥­å·®åˆ†è¨ˆç®—
    const baseOvertimeStart = 18 * 60;
    const sortedOvertimes = entryData
      .filter(d => d.overtimeEndMinutes !== null)
      .sort((a, b) => a.overtimeEndMinutes - b.overtimeEndMinutes);

    let prevEndSorted = baseOvertimeStart;

    sortedOvertimes.forEach(d => {
      if (d.overtimeEndMinutes > prevEndSorted) {
        const diff = d.overtimeEndMinutes - prevEndSorted;
        d.overtimeAfterMinutes = diff;
        prevEndSorted = d.overtimeEndMinutes;
      }
    });

    // ä»¶åã”ã¨ã«åˆè¨ˆæ™‚é–“åæ˜ 
    entryData.forEach(d => {
      const totalEntryMinutes = d.workMinutes + d.overtimeBeforeMinutes + d.overtimeAfterMinutes;
      const totalEntryOvertime = d.overtimeBeforeMinutes + d.overtimeAfterMinutes;

      d.entry.output.textContent = `é¸æŠæ™‚é–“: ${(totalEntryMinutes / 60).toFixed(1)} æ™‚é–“ (æ®‹æ¥­: ${(totalEntryOvertime / 60).toFixed(1)} æ™‚é–“)` ;

      totalMinutes += totalEntryMinutes;
      totalOvertime += totalEntryOvertime;
    });
      
    // --- å…¨ä½“åˆè¨ˆè¡¨ç¤º ---
    overallTotalEl.textContent = (totalMinutes / 60).toFixed(1);
    overtimeTotalEl.textContent = (totalOvertime / 60).toFixed(1);

    updateSlotDisabling();
  }

  let outsideClickListener = null; // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å‚ç…§ã‚’ä¿æŒ

  // ãƒ¢ãƒ¼ãƒ€ãƒ«
  function showTimeModal(targetInput, type, entries = []) {
  const modal = document.getElementById('timeModal');
  const overlay = document.getElementById('modalOverlay');
  const container = document.getElementById('timeOptionsContainer');
  const clearButton = document.getElementById('clearTimeModal');

  // å‰å›ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’æ¶ˆå»
  if (outsideClickListener) {
    document.removeEventListener('click', outsideClickListener);
    outsideClickListener = null;
  }
  

  // é™¤å¤–ã—ãŸã„æ™‚é–“å¸¯
  const excludedTimesMap = {
    before: [{ start: 0 * 60, end: 4 * 60 },
             { start: 8 * 60, end: 23 * 60 + 31 }
    ],
    after: [{ start: 4 * 60, end: 19 * 60 }]
  };

  const excludedTimes = excludedTimesMap[type] || [];

  // ç›´è¿‘ã®ä½œæ¥­çµ‚äº†æ™‚åˆ»ã‚’å–å¾—
  let minSelectable = 0;
  if (type === 'after' && entries.length > 0) {
    const latestEndStr = getLatestActualEnd(entries);
    if (latestEndStr) {
      minSelectable = timeToMinutes(latestEndStr);
    }
  }

 // æ™‚é–“ãƒœã‚¿ãƒ³ã®ç”Ÿæˆ
 container.innerHTML = '';
 container.appendChild(clearButton); // ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³ã‚’å†åº¦è¿½åŠ 

//  è¡¨ç¤ºç”¨ã®æ™‚é–“ãƒªã‚¹ãƒˆã‚’ç”Ÿæˆ
  const timeList = [];
  for (let h = 0; h < 24; h++) {
    for (let m of [0, 30]) {
      const totalMinutes = h * 60 + m;

      // é™¤å¤–æ™‚é–“ãƒã‚§ãƒƒã‚¯
      const isExcluded = excludedTimes.some(({ start, end }) => {
        if (start <= end) {
          return totalMinutes >= start && totalMinutes < end;
        } else {
          // 23:30~ç¿Œ3:00 ã®ã‚ˆã†ãªè·¨ãã‚’è€ƒæ…®
          return totalMinutes >= start || totalMinutes < end;
        }
      });

      if (!isExcluded) {
        if (type === 'after' && totalMinutes <= minSelectable) continue;
        timeList.push({ timeStr: `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`, totalMinutes });

      }
    }
  }

  // ä¸¦ã³æ›¿ãˆ:ã€Œ4:00~23:30ã€â†’ã€Œ0:00~3:30ã€
  const reorderedTime =[
    ...timeList.filter(t => t.totalMinutes >= 4 * 60),
    ...timeList.filter(t => t.totalMinutes < 4 * 60)
  ];

  // å‰æ®‹æ¥­ã®ã¨ãã¯æ™‚é–“ã‚’é€†é †ã«ã™ã‚‹
  if (type === 'before') {
    reorderedTime.reverse();
  }

  // æ™‚é–“ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ 
  for (const { timeStr } of reorderedTime) {
    const div = document.createElement('div');
    div.className = 'time-option';
    div.textContent = timeStr;

    div.addEventListener('click', () => {
      targetInput.value = timeStr;  // å…¥åŠ›æ¬„ã«ã¯ hh:mm ã§è¡¨ç¤º

      // overtimeAfter ã®å ´åˆã¯ overtimeEnd ã¨ã—ã¦ä¿å­˜
      if (type === 'after') {
        const index = allEntries.findIndex(e => e.overtimeAfter === targetInput);
        if (index !== -1) {
          allEntries[index].overtimeEnd = timeStr;
        }
      }

      updateAllTotals();

      
      document.removeEventListener('click', outsideClickListener);
      closeModal();
    });

    container.appendChild(div);

  }

  // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºå‡¦ç†
   
  if (window.innerWidth > 768) {
    // PCã®ã¨ãã ã‘å…¥åŠ›æ¬„ã®ä¸‹ã«è¡¨ç¤º
    const rect = targetInput.getBoundingClientRect();
    const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
    const scrollLeft = window.pageXOffset || document.documentElement.scrollLeft;

    modal.style.position = 'absolute';
    modal.style.top = (rect.bottom + scrollTop) + 'px';
    modal.style.left = (rect.left + scrollLeft) + 'px';
    modal.style.transform = 'none';

   } 
   else {
    modal.style.position = 'fixed';
    modal.style.top = `50%`;
    modal.style.left = `50%`;
    modal.style.transform = 'translate(-50%, -50%)';
  }

  // ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã¨ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
  overlay.classList.add('active');
  modal.classList.add('active');
  modal.style.display = 'block';

  // èƒŒæ™¯ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ç¦æ­¢
  document.body.style.overflow = 'hidden';

  // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹å‡¦ç†
  function closeModal() {
    overlay.classList.remove('active');
    modal.classList.remove('active');
    document.body.style.overflow = '';

    // transitionçµ‚äº†å¾Œã« diaplay:none
    modal.addEventListener('transitionend', () => {
      if (!modal.classList.contains('active')) modal.style.display = 'none';
    }, { once: true });

    // ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚‚åŒæ§˜ã«éè¡¨ç¤º
    overlay.addEventListener('transitionend', () => {
      if (!overlay.classList.contains('active')) overlay.style.display = 'none';
    }, { once: true });

    // å¤–å´ã‚¯ãƒªãƒƒã‚¯è§£é™¤
    if (outsideClickHandler) {
      document.removeEventListener('click', outsideClickHandler);
      outsideClickHandler = null;
    }
  }

  // èƒŒæ™¯ã‚¿ãƒƒãƒ—ã§é–‰ã˜ã‚‹
  overlay.onclick = closeModal;

  // PCã®ã¿å¤–å´ã‚¯ãƒªãƒƒã‚¯ã§ã‚‚é–‰ã˜ã‚‹
  if (window.innerWidth > 768) {
    outsideClickHandler = function (e) {
      if (!modal.contains(e.target) && !targetInput.contains(e.target)) {
        closeModal();
      }
    };

    setTimeout(() => {
      document.addEventListener('click', outsideClickHandler);
    }, 0);
}
  // ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³
  clearButton.onclick = () => {
    targetInput.value = '';

    // overtimeEEnd ã‚‚ã‚¯ãƒªã‚¢
    if (type === 'after') {
      const index = allEntries.findIndex(e => e.overtimeAfter === targetInput);
      if (index !== -1) {
        allEntries[index].overtimeEnd = null;
      }
    }
    updateAllTotals();

    closeModal();
    
  }; 
}


  function toggleNameInpit() {
    const nameSelect = document.getElementById("nameSelect");
    const customName = document.getElementById("customName");
    if (nameSelect.value === "__other__") {
      customName.style.display = "inline-block";
    } else {
      customName.style.display = "none";
    }
  }

  function submitReports() {
    const nameSelect = document.getElementById("nameSelect");
    const customName = document.getElementById("customName");
    let name = "";
    const date = document.getElementById("dateInput").value;
    if (!date) {
      alert("æ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„");
      return;
    }

    if (nameSelect.value === "__other__") {
      name = customName.value.trim();
      if (!name) {
        alert("åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
        return;
      } 
    } else {
      name = nameSelect.value;
      if (!name) {
        alert("åå‰ã‚’é¸æŠã—ã¦ãã ã•ã„");
        return;
      }
    }

    // ä¼‘æ—¥å‡ºå‹¤ã®ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®çŠ¶æ…‹ã‚’å–å¾—
    const isHolidayWork = document.getElementById("isHolidayWork").checked
  
    const reports = allEntries.map(entry => {
      const selectedSlots = entry.slots.filter(s => s.classList.contains('selected'));
      const workMinutes = selectedSlots.length * 30;
      const overtimeBefore = timeStrToMinutes(entry.overtimeBefore.value, 'before');
      const overtimeAfter = timeStrToMinutes(entry.overtimeAfter.value, 'after');
      const total = workMinutes + overtimeBefore + overtimeAfter;
      // æœ‰ä¼‘å…¥åŠ›ã®å–å¾—
      const paidLeaveInput = entry.paidLeaveInput;
      const paid_leave_hours = parseFloat(paidLeaveInput.value) || 0;
      const paid_leave_minutes = Math.round(paid_leave_hours * 60);

        // start / end ã®æ™‚é–“ã‚’ã“ã“ã§å–å¾—
      let start_time = null;
      let end_time = null;

      if (selectedSlots.length > 0) {
        start_time = selectedSlots[0].dataset.time;
        end_time = selectedSlots[selectedSlots.length - 1].dataset.time;
      }

      let [start_hour, start_minute] = start_time ? start_time.split(':').map(Number) : [null, null];
      let [end_hour, end_minute] = end_time ? end_time.split(':').map(Number) : [null, null];

      // å…¥åŠ›é …ç›®ã®å–å¾—
      const fieldRow = entry.slots[0].closest('.entry').querySelector('.entry-fields');
      const inputs = fieldRow.querySelectorAll('input');


      // é€ä¿¡ãƒ‡ãƒ¼ã‚¿ã«å«ã‚ã‚‹
      return {
        title: inputs[0].value,
        task: inputs[1].value,
        partner: inputs[2].value,
        work_minutes: workMinutes,
        overtime_before: overtimeBefore,
        overtime_after: overtimeAfter,
        total_minutes: total,
        start_hour,
        start_minute,
        end_hour,
        end_minute,
        paid_leave_minutes,
      };
    });

    // é€ä¿¡ãƒ‡ãƒ¼ã‚¿ã‚’ã¾ã¨ã‚ã‚‹
    const data = {
      name,
      date,
      is_holiday_work: isHolidayWork,
      reports
    };

    console.log(JSON.stringify(data, null, 2));

    // POSTé€ä¿¡
    fetch('/submit', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name, date, is_holiday_work: isHolidayWork, reports })
    }).then(res => res.json()).then(data => {
      if (data.status === 'success') alert('ä¿å­˜ã—ã¾ã—ãŸï¼');
      else alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
    });
  }


  //ä»Šæ—¥ã®æ—¥ä»˜ã‚’å–å¾—
  const today = new Date();
  const yyyy = today.getFullYear();
  const mm = String(today.getMonth() +1).padStart(2, '0');
  const dd = String(today.getDate()).padStart(2, '0');
  const todayStr = `${yyyy}-${mm}-${dd}`;

  document.getElementById('dateInput').value = todayStr;

  // ã‚¨ãƒ³ãƒˆãƒªãƒ¼ã‚’åˆæœŸè¡¨ç¤º
  createEntries(parseInt(entryCountSelector.value, 10));

  // ã‚»ãƒ¬ã‚¯ãƒˆå¤‰æ›´æ™‚ã«å†ç”Ÿæˆ
  entryCountSelector.addEventListener('change', () => {
    const oldInputs = [];

    // ã™ã§ã«å…¥åŠ›ã•ã‚ŒãŸå†…å®¹ã‚’ä¿å­˜
    document.querySelectorAll('.entry').forEach(entry => {
      const title = entry.querySelector('.title')?.value || '';
      const task = entry.querySelector('.task')?.value || '';
      const partner = entry.querySelector('.partner')?.value || '';
      oldInputs.push({ title, task, partner });
    });

    const count = parseInt(entryCountSelector.value, 10);
    createEntries(count);

    // å†ç”Ÿæˆå¾Œã«ä¿å­˜ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒ
    document.querySelectorAll('.entry').forEach((entry, i) => {
      if (i < oldInputs.length) {
        entry.querySelector('.title').value = oldInputs[i].title;
        entry.querySelector('.task').value = oldInputs[i].task;
        entry.querySelector('.partner').value = oldInputs[i].partner;
      }
    });
  });

</script>

</body>
</html>
