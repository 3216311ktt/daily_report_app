<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>日報入力</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
    }
    .entry {
      margin-bottom: 20px;
    }
    .entry-fields {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 4px;
      align-items: center;
    }
    input[type="text"], select {
      padding: 4px;
      font-size: 13px;
    }
    input.title { width: 200px; }
    input.task { width: 400px; }
    input.partner { width: 200px; }

    .timeline-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 6px 0;
    }
    .timeline-wrapper {
      overflow-x: auto;
      white-space: nowrap;
      border: 1px solid #ccc;
    }
    .timeline {
      display: inline-flex;
    }
    .clear-button {
      margin-left: auto;
      margin-right: 0;
      padding: 4px 10px;
      font-size: 12px;
    }
    .slot {
      flex: 0 0 auto;
      width: 26px;
      padding: 4px 2px;
      text-align: left;
      font-size: 9px;
      border-right: 1px solid #eee;
      border-bottom: 1px solid #eee;
      cursor: pointer;
      user-select: none;
      padding-left: 2px;
    }
    .slot.selected {
      background-color: #90ee90;
    }
    .slot.disabled {
      background-color: #f0f0f0;
      cursor: not-allowed;
      pointer-events: none;
    }
    .slot.bold-left {
      border-left: 2px solid #555;
    }
    .output {
      margin-top: 5px;
      font-size: 12px;
    }
    .total-time {
      font-weight: bold;
      margin-top: 10px;
      font-size: 14px;
    }
    .overtime-select {
      font-size: 13px;
    }
    .submit {
      background-color: rgb(146, 191, 146);
      height: 40px;
      width: 300px;
      font-size: large;
      margin-left: 300px;
    }
  </style>
</head>
<body>

<h2>📝 日報入力</h2>
<tr>
  <label for="dateInput"> 日付を選択</label>
  <input type="date" id="dateInput" name="date">
  <label for="entryCountSelector">件名数</label>
  <select id="entryCountSelector">
    <option value="1" selected>1　件</option>
    <option value="2">2　件</option>
    <option value="3">3　件</option>
    <option value="4">4　件</option>
    <option value="5">5　件</option>
  </select>
</tr>
<br>
<br>
<div id="entries"></div>

<div class="total-time">総合計時間: <span id="overall-total">0</span> 時間</div>
<div class="total-time">残業時間合計: <span id="overtime-total">0</span> 分</div>

<button onclick="submitReports()" class="submit">送信</button>

<script>
  const startHour = 8;
  const endHour = 18;
  const interval = 30;

  const entriesEl = document.getElementById('entries');
  const overallTotalEl = document.getElementById('overall-total');
  const overtimeTotalEl = document.getElementById('overtime-total');
  const entryCountSelector = document.getElementById('entryCountSelector');
  
  let allEntries = [];

  function createTimeSlots() {
    const slots = [];
    for (let h = startHour; h < endHour; h++) {
      for (let m of [0, 30]) {
        const time = `${h}:${m.toString().padStart(2, '0')}`;
        const label = m === 0 ? `${h}` : ``;

        const isDisabled = (h === 8 && m === 0) || (h === 12 && m <= 30) || (h === 17 && m == 30);
        const isBoldLeft = (h === 8 && m === 30) || (h === 17 && m === 30);

        slots.push({ time, label, disabled: isDisabled, boldLeft: isBoldLeft });
      }
    }
    return slots;
  }

  function createEntries(entryCount) {
    entriesEl.innerHTML = '';
    allEntries = []

  for (let i = 0; i < entryCount; i++) {
    const wrapper = document.createElement('div');
    wrapper.className = 'entry';

    const fieldRow = document.createElement('div');
    fieldRow.className = 'entry-fields';

    const titleInput = document.createElement('input');
    titleInput.type = 'text';
    titleInput.placeholder = `件名 ${i + 1}`;
    titleInput.className = 'title';

    const taskInput = document.createElement('input');
    taskInput.type = 'text';
    taskInput.placeholder = `作業内容`;
    taskInput.className = 'task';

    const partnerInput = document.createElement('input');
    partnerInput.type = 'text';
    partnerInput.placeholder = `同行者`;
    partnerInput.className = 'partner';

    fieldRow.appendChild(titleInput);
    fieldRow.appendChild(taskInput);
    fieldRow.appendChild(partnerInput);
    wrapper.appendChild(fieldRow);

    const timelineRow = document.createElement('div');
    timelineRow.className = 'timeline-row';

    const beforeWrapper = document.createElement('div');
    const beforeLabel = document.createElement('span');
    beforeLabel.textContent = '前残業: ';
    const overtimeBefore = document.createElement('select');
    overtimeBefore.className = 'overtime-select';

    const afterWrapper = document.createElement('div');
    const afterLabel = document.createElement('span');
    afterLabel.textContent = '後残業: ';
    const overtimeAfter = document.createElement('select');
    overtimeAfter.className = 'overtime-select';

          // === 🧹 クリアボタンの追加 ===
    const clearBtn = document.createElement('button');
    clearBtn.textContent = 'クリア';
    clearBtn.style.fontSize = '12px';
    clearBtn.style.padding = '4px 10px';
    clearBtn.style.flexShrink = '0';
    clearBtn.addEventListener('click', () => {
      slots.forEach(slot => slot.classList.remove('selected'));
      overtimeBefore.value = 0;
      overtimeAfter.value = 0;
      updateAllTotals();

  });
  

    for (let j = 0; j <= 12; j++) {
      const min = j * 30;
      const opt = document.createElement('option');
      opt.value = min;
      opt.textContent = min === 0 ? '0時間' : `${min / 60}時間`;
      overtimeBefore.appendChild(opt.cloneNode(true));
      overtimeAfter.appendChild(opt);
    }

    beforeWrapper.appendChild(beforeLabel);
    beforeWrapper.appendChild(overtimeBefore);
    afterWrapper.appendChild(afterLabel);
    afterWrapper.appendChild(overtimeAfter);

    const timelineWrapper = document.createElement('div');
    timelineWrapper.className = 'timeline-wrapper';

    const timeline = document.createElement('div');
    timeline.className = 'timeline';

    const slots = createTimeSlots().map(({ time, label, disabled, boldLeft }) => {
      const el = document.createElement('div');
      el.className = 'slot';
      if (disabled) el.classList.add('disabled');
      if (boldLeft) el.classList.add('bold-left');
      el.dataset.time = time;
      el.textContent = label;
      timeline.appendChild(el);
      return el;
    });

    timelineWrapper.appendChild(timeline);

    timelineRow.appendChild(beforeWrapper);
    timelineRow.appendChild(timelineWrapper);
    timelineRow.appendChild(afterWrapper);
  
    wrapper.appendChild(timelineRow);
 
    // 出力行とクリアボタンを包む　div を作成
    const bottomRow = document.createElement('div');
    bottomRow.style.display = 'flex';
    bottomRow.style.alignItems = 'center';
    bottomRow.style.marginTop = '6px';
    bottomRow.style.width = '760px';
    bottomRow.style.boxSizing = 'border-box';

    // 選択時間を表示
    const output = document.createElement('div');
    output.className = 'output';
    output.textContent = `選択時間: 0 時間`;

    // spacer
    const spacer = document.createElement('div');
    spacer.style.flex = '1';

    bottomRow.appendChild(output);
    bottomRow.appendChild(spacer);
    bottomRow.appendChild(clearBtn);
    wrapper.appendChild(bottomRow);

    entriesEl.appendChild(wrapper);

    allEntries.push({ slots, output, overtimeBefore, overtimeAfter });
  }

  setupSlotEventHandlers();
  updateAllTotals();
}

  function setupSlotEventHandlers() {
    allEntries.forEach(entry => {
      let isDragging = false;

      entry.slots.forEach(slot => {
        function toggleSlot(target) {
          if (target.classList.contains('disabled')) return;
          target.classList.toggle('selected');
          updateAllTotals();
        }

        function selectSlot(target) {
          if (target.classList.contains('disabled') || target.classList.contains('selected')) return;
          target.classList.add('selected');
          updateAllTotals();
        }

        slot.addEventListener('mousedown', () => {
          isDragging = true;
          toggleSlot(slot);
        });

        slot.addEventListener('mousemove', (e) => {
          if (isDragging && e.buttons) {
            selectSlot(slot);
          }
        });

        slot.addEventListener('touchstart', (e) => {
          e.preventDefault();
          isDragging = true;
          toggleSlot(slot);
        }, { passive: false });

        slot.addEventListener('touchmove', (e) => {
          e.preventDefault();
          const touch = e.touches[0];
          const target = document.elementFromPoint(touch.clientX, touch.clientY);
          if (target && target.classList.contains('slot')) {
            selectSlot(target);
          }
        }, { passive: false });

        document.addEventListener('mouseup', () => isDragging = false);
        document.addEventListener('touchend', () => isDragging = false);
      });

      entry.overtimeBefore.addEventListener('change', updateAllTotals);
      entry.overtimeAfter.addEventListener('change', updateAllTotals);
    });
  }

  function updateAllTotals() {
    let totalMinutes = 0;
    let totalOvertime = 0;

    allEntries.forEach(entry => {
      const selected = entry.slots.filter(s => s.classList.contains('selected'));
      const minutes = selected.length * 30;

      const overtimeBefore = parseInt(entry.overtimeBefore.value, 10);
      const overtimeAfter = parseInt(entry.overtimeAfter.value, 10);
      const overtime = overtimeBefore + overtimeAfter;

      totalMinutes += minutes + overtime;
      totalOvertime += overtime;

      entry.output.textContent = `選択時間: ${(minutes + overtime) / 60} 時間（残業: ${(overtime / 60).toFixed(1)} 時間)`;
    });

    overallTotalEl.textContent = (totalMinutes / 60).toFixed(1);
    overtimeTotalEl.textContent = totalOvertime;
  }

  allEntries.forEach(entry => {
    let isDragging = false;

    entry.slots.forEach(slot => {
      function toggleSlot(target) {
        if (target.classList.contains('disabled')) return;
        target.classList.toggle('selected');
        updateAllTotals();
      }

      function selectSlot(target) {
        if (target.classList.contains('disabled') || target.classList.contains('selected')) return;
        target.classList.add('selected');
        updateAllTotals();
      }

      slot.addEventListener('mousedown', () => {
        isDragging = true;
        toggleSlot(slot);
      });

      slot.addEventListener('mousemove', (e) => {
        if (isDragging && e.buttons) {
          selectSlot(slot);
        }
      });

      slot.addEventListener('touchstart', (e) => {
        e.preventDefault();
        isDragging = true;
        toggleSlot(slot);
      }, { passive: false });

      slot.addEventListener('touchmove', (e) => {
        e.preventDefault();
        const touch = e.touches[0];
        const target = document.elementFromPoint(touch.clientX, touch.clientY);
        if (target && target.classList.contains('slot')) {
          selectSlot(target);
        }
      }, { passive: false });

      document.addEventListener('mouseup', () => isDragging = false);
      document.addEventListener('touchend', () => isDragging = false);
    });

    entry.overtimeBefore.addEventListener('change', updateAllTotals);
    entry.overtimeAfter.addEventListener('change', updateAllTotals);
  });

  function submitReports() {
    const name = prompt("名前を入力してください");
    if (!name) return;

    const reports = allEntries.map(entry => {
      const workMinutes = entry.slots.filter(s => s.classList.contains('selected')).length * 30;
      const overtimeBefore = parseInt(entry.overtimeBefore.value, 10);
      const overtimeAfter = parseInt(entry.overtimeAfter.value, 10);
      const total = workMinutes + overtimeBefore + overtimeAfter;

      const fieldRow = entry.slots[0].closest('.entry').querySelector('.entry-fields');
      const inputs = fieldRow.querySelectorAll('input');

      return {
        title: inputs[0].value,
        task: inputs[1].value,
        partner: inputs[2].value,
        work_minutes: workMinutes,
        overtime_before: overtimeBefore,
        overtime_after: overtimeAfter,
        total_minutes: total
      };
    });

    fetch('/submit', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name, reports })
    }).then(res => res.json()).then(data => {
      if (data.status === 'success') alert('保存しました！');
      else alert('保存に失敗しました');
    });
  }

  //今日の日付を取得
  const today = new Date();
  const yyyy = today.getFullYear();
  const mm = String(today.getMonth() +1).padStart(2, '0');
  const dd = String(today.getDate()).padStart(2, '0');
  const todayStr = `${yyyy}-${mm}-${dd}`;

  document.getElementById('dateInput').value = todayStr;

  // エントリーを初期表示
  createEntries(parseInt(entryCountSelector.value, 10));

  // セレクト変更時に再生成
  entryCountSelector.addEventListener('change', () => {
    const count = parseInt(entryCountSelector.value, 10);
    createEntries(count);
  });
</script>

</body>
</html>

